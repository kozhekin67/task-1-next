# S&P Git Flow
> Рекомендованная схема ведения git репозитория.  
> Данный материал не является учебником по использованию git и предполагает,
> что читающий уже знаком с git. Список материалов для изучения git можно
> посмотреть [здесь](gitflow/git_tutorials.md).

## 1. Словарь терминов

Деплой — процесс доставки и установки реализованного функционала на площадку.

Площадка — некие аппаратные средства, чаще всего сервер, предназначенные для функционирования проекта.

Боевая площадка — площадка, предназначенная для функционирования проекта.

Тестовая площадка — площадка, предназначенная для тестирования проекта.

Feature (улучшение) — некоторая доработка, связанная с созданием нового функционала.

Fix (исправление) — некоторая доработка, связанная с устранением неисправности существующего функционала.

## 2. Именование ветвей репозитория

`develop` — основная ветвь, используемая для разработки, подготовка к следующему
релизу;

`feature/.*` — ветви дополнительного функционала;

`t/<year><month><day>` — тестовая ветвь;

`release/<year><month><day>` — ветвь релиза;

`master` — ветвь закрытых релизов.

## 3. Общие правила

1. Содержимое ветви `master` всегда работоспособно (deployable).
2. Нельзя перезаписывать (`git push -f`) содержание веток `develop` и `master`.
3. Любые изменения делаются через создание новой ветви `feature/.*`.

Правила именования: `<issue_id>_<name>`, где `issue_id` - номер задачи в системе
управления проектом, `name` - краткое описание изменений.

4. Ветви `feature/.*` закрываются (вливаются в `develop`) только после
   подтверждения возможности деплоя (менеджером) данного функционала при следующем
   релизе.
5. Если есть необходимость продемонстрировать неколько независимых улучшений,
   не утвержденных для включения в основною версию продукта, следует использовать
   тестовые ветви (`t/<year><month><day>`).
6. Если над проектом работает больше одного человека необходимо назначить
   Git-мастера. Git-мастером обычно назначается ведущий разработчик на проекте.
7. Деплой на боевую площадку производится из ветки `release/<year><month><day>`
   или `master`. Ветвь релиза имеет приоритет над `master`.
8. Git-мастер, при явной необходимости, может нарушать эти правила.

## 4. Правила именования коммитов

1. Рекомендованная длина строки в коммите составляет 72 символа.

2. Язык заголовка — английский.
   Язык детального описания — английский или русский.

3. Текст коммита должен соответствовать одному из следующих шаблонов

**Краткий коммит**
```
%Тип действия% %краткое описание% [#%номер задачи%]
```

**Детальный коммит**
```
%Тип действия% %краткое описание% [#%номер задачи%]
[#%номер задачи%]
%Детальное описание коммита%
```

`%Тип действия%` - описывает тип вашего изменения.

Допустимые ключевые слова для описания типа действия:

- Add
- Change
- Refactor
- Merge
- Remove
- Fix

**Важно!** Описание типа действия должно начинаться с заглавной буквы.

`%краткое описание%` - краткое описание внесённых изменений.

`%номер задачи%` - *Необязательный параметр*. Номер задачи в системе контроля версий.
Рекомендуется указывать его в первом коммите по задаче.

[Примеры правильно названных коммитов](gitflow/commits_examples.md).

## 5. User Stories

Для упрощения работы следует использовать утилиту [Git
Flow](http://danielkummer.github.io/git-flow-cheatsheet/index.ru_RU.html).

### 5.1. Создание нового проекта

`$PROJECT_PATH` - папка для нового проекта

  ```bash
  cd $PROJECT_PATH
  git init
  # создание вашего первого коммита
  git checkout -b develop
  git config gitflow.prefix.versiontag 'r/'
  git flow init -d
  ```

### 5.2. Клонирование существующего проекта

`$GIT_REPOSITORY` - адрес репозитория. Например: `git@git.snpdev.ru:saltpepper/snp-git-flow.git`  
`$PROJECT_PATH` - папка для нового проекта

  ```bash
  git clone $GIT_REPOSITORY
  cd $PROJECT_PATH
  git config gitflow.prefix.versiontag 'r/'
  git flow init -d
  ```

### 5.3. Вы приступаете к работе на проекте первый раз за день

Обновляем `develop` ветку локального репозитория.

  ```bash
  git checkout develop
  git pull --rebase
  ```

### 5.4. Необходимо разработать дополнительный функционал к проекту

2. Создаем `feature/.*` ветку с названием `feature/$FEATURE_BRANCH`.

`$FEATURE_BRANCH` - краткое описание изменений. Например:
9568_add_borsch_contest

  ```bash
  git flow feature start $FEATURE_BRANCH
  ```

2. Выполняем задачу создавая коммиты в текущую ветку

  ```bash
  ...
  git add ...
  git commit ...
  ...
  ```
**Важно!**
Перед каждым коммитом проверяйте работоспособность приложения, а также
просматривайте свои изменения на предмет опечаток, лишних пробелов, неверных
отступов. Также старайтесь не оставлять закомментированный код, который
не будет использоваться в дальнейшем, и вызовы отладочных логов в консоль.

3. Как можно чаще синхронизируемся с веткой `origin/develop` с помощью rebase



  ```bash
  git fetch origin
  git rebase origin/develop
  git push -f origin develop
  ```

    **Важно!**
Не выполняйте данный пункт, если над веткой работает более одного человека
или от вашей ветки созданы другие ветки

Подробнее о rebase [здесь](http://git-scm.com/book/ru/v1/Ветвление-в-Git-Перемещение).

### 5.5. Необходимо **срочно** разработать дополнительный функционал к проекту

1. Сохраняем все во временное хранилище

  ```bash
  git add --all && git stash
  ```

2. Выполняем действия из пункта 5.4

3. Возвращаем изменения из временного хранилища

  ```bash
  git stash pop
  ```

### 5.6. Дополнительный функционал готов к деплою

1. Проверяем наличие конфликтов с `develop` веткой. Если конфликты не найдены,
   переходим к следующему шагу.
   Иначе, разрешаем конфликт, проверяем работоспособность приложения, делаем
   коммиты и переходим к следующему шагу

2. После того, как все необходимые изменения были зафиксированы в коммитах и
   протестированы, ветка `feature/.*` готова к слиянию в `develop`.

`$FEATURE_BRANCH` - краткое описание изменений. Например: 9568_add_borsch_contest

  ```bash
  git checkout develop
  git pull
  git checkout feature/$FEATURE_BRANCH
  git pull
  git flow feature finish
  ```

Если в двух ветках были сделаны изменения, касающиеся одного и того же
функционала, при слиянии и ребейсе могут возникать конфликты.
[Здесь
](http://git-scm.com/book/ru/v1/Ветвление-в-Git-Основы-ветвления-и-слияния#Основы-конфликтов-при-слиянии)
и [здесь
](http://githowto.com/ru/resolving_conflicts) можно узнать, как разрешать
конфликты.

### 5.7. Дополнительный функционал готов к деплою на боевой сервер

1. Создаем релизную ветку `release/<year><month><day>`;
   ```bash
   git flow release start $RELEASE_NAME # $RELEASE_NAME = <year><month><day>
   git push -u origin release/$RELEASE_NAME  # публикация релиза на origin
   ```

2. Проверяем работоспособность внесенных изменений на боевом сервере;

3. Вносим правки в релизную ветвь; повторяем пункты 2 и 3 до момента, пока все
   недоработки не будут исправлены;
4. Если в течении того же дня в develop вливаются улучшения, которые так
   же нужно задеплоить на боевой серевер, необходимо в текущую релизную ветвь влить  
   `develop`;
  ```bash
    git checkout release/$RELEASE_NAME
    git merge develop --ff
  ```

5. При создания нового релиза закрываем текущий: cливаем релизную ветку с `master` и `develop` и удаляем её.

  ```bash
    git flow release finish $RELEASE_NAME
  ```

### 5.8 Необходимо продемонстрировать неколько независимых улучшений

1. Создаем тестовую ветку `t/<year><month><day>` от `develop`;

  ```bash
    git checkout develop
    git checkout -b t/$DATE # $DATE = <year><month><day>
  ```
2. Сливаем в тестовую ветку нужные улучшения

  ```bash
    git merge feature/feature1
    git merge feature/feature2
    git merge feature/feature3
  ```
3. Публикуем тестовую ветку

  ```bash
    git push -u origin t/$DATE # публикация на origin 
  ```

4. Удаляем тестовую ветку, как только она становится не нужна

  ```bash
    git branch -d t/$DATE # удаление ветви локально
    git push origin --delete t/$DATE # удаление ветви на origin
  ```